var fe,__assign=this&&this.__assign||Object.assign||function(t){for(var i,e=1,n=arguments.length;e<n;e++)for(var s in i=arguments[e])Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s]);return t},__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])};return function(t,i){function e(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}}();!function(t){var i=function(){function t(t){var i=void 0===t?{}:t,e=i.fontFamily,n=void 0===e?"Times":e,s=i.fontWeight,r=void 0===s?"normal":s,o=i.fontSize,h=void 0===o?200:o,u=i.origin,d=void 0===u?"baseline":u;this.initialized=!1,this.settings={chars:{capHeight:"S",baseline:"n",xHeight:"x",descent:"p",ascent:"h",tittle:"i"}},this.setFont(n,h,r),this.res=__assign({},this.normalize(this.getMetrics(),h,d),{fontFamily:n,fontWeight:r,fontSize:h})}return t.prototype.getAscent=function(){return-this.res.ascent},t.prototype.getDescent=function(){return this.res.descent},t.prototype.initialize=function(){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initialized=!0},t.prototype.setFont=function(t,i,e){this.initialized||this.initialize(),this.padding=.5*i,this.canvas.width=2*i,this.canvas.height=2*i+this.padding,this.context.font=e+" "+i+"px "+t,this.context.textBaseline="top",this.context.textAlign="center"},t.prototype.setAlignment=function(t){void 0===t&&(t="top");var i="bottom"===t?this.canvas.height:0;this.context.setTransform(1,0,0,1,0,i),this.context.textBaseline=t},t.prototype.updateText=function(t){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillText(t,this.canvas.width/2,this.padding,this.canvas.width)},t.prototype.computeLineHeight=function(){this.setAlignment("bottom");var t=this.canvas.height-this.measureBottom("A");return this.setAlignment("top"),this.measureBottom("A")+t},t.prototype.getPixels=function(t){return this.updateText(t),this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data},t.prototype.getFirstIndex=function(t){for(var i=3,e=t.length;i<e;i+=4)if(0<t[i])return(i-3)/4;return t.length},t.prototype.getLastIndex=function(t){for(var i=t.length-1;3<=i;i-=4)if(0<t[i])return i/4;return 0},t.prototype.normalize=function(t,i,e){var n={},s=t[e];for(var r in t)n[r]=t[r]-s;return n},t.prototype.measureTop=function(t){return Math.round(this.getFirstIndex(this.getPixels(t))/this.canvas.width)-this.padding},t.prototype.measureBottom=function(t){return Math.round(this.getLastIndex(this.getPixels(t))/this.canvas.width)-this.padding},t.prototype.getMetrics=function(t){return void 0===t&&(t=this.settings.chars),{capHeight:this.measureTop(t.capHeight),baseline:this.measureBottom(t.baseline),xHeight:this.measureTop(t.xHeight),descent:this.measureBottom(t.descent),bottom:this.computeLineHeight(),ascent:this.measureTop(t.ascent),tittle:this.measureTop(t.tittle),top:0}},t}();t.FontMetrics=i}(fe||(fe={})),function(t){var i=function(){function t(t,i,e){t&&(this.h1=t),i&&(this.h2=i),e&&(this.w=e)}return t.prototype.clone=function(){return new t(this.h1,this.h2,this.w)},t.prototype.add=function(t){return this.h1=this.h1>t.h1?this.h1:t.h1,this.h2=this.h2>t.h2?this.h2:t.h2,this.w+=t.w,this},t.prototype.copyDim=function(t){return this.h1=t.h1,this.h2=t.h2,this.w=t.w,this},t.prototype.copy=function(t,i,e){return this.h1=t,this.h2=i,this.w=e,this},t.prototype.isIn=function(t,i){return-this.h1<=i&&i<=this.h2&&0<=t&&t<=this.w},t.prototype.toString=function(){return"("+this.h1+", "+this.h2+"; "+this.w+")"},t}();t.Dim=i}(fe||(fe={})),function(e){var t=function(){function t(t,i){this.next=null,this.prev=null,this.fp=t,this.parent=i,this.dim=new e.Dim(0,0,0)}return t.prototype.getNCon=function(){return 0},t.prototype.setCon=function(t,i){},t.prototype.getCon=function(t){return null},t.prototype.insertAsNext=function(t){t.prev=this,t.next=this.next,null!=(this.next=t).next&&(t.next.prev=t)},t.prototype.insertChainAsNext=function(t){if(null!=(t.prev=this).next){var i=t.last();i.next=this.next,null!=i.next&&(i.next.prev=i)}this.next=t},t.prototype.getBehavior=function(){return t.SIMPLE_DELETE},t.prototype.getDim=function(){return this.dim},t.prototype.getCursorDim=function(){return this.dim},t.prototype.calcDim=function(t,i){},t.prototype.calcDimAll=function(t,i,e){this.iFontSize=t,this.calcDim(t,e),i.add(this.dim),null!=this.next&&this.next.calcDimAll(t,i,e)},t.prototype.paint=function(t,i,e){},t.prototype.paintAll=function(t,i,e){if(this.x=i,this.y=e,this.fp.debug){var n=t.getContext("2d");n.save(),n.strokeStyle="#4400FF",n.strokeRect(i,e-this.dim.h1,this.dim.w,this.dim.h1),n.strokeRect(i,e,this.dim.w,this.dim.h2),n.restore()}this.paint(t,i,e),null!=this.next&&this.next.paintAll(t,i+this.dim.w,e)},t.prototype.first=function(){return null!=this.prev?this.prev.first():this},t.prototype.last=function(){return null!=this.next?this.next.last():this},t.prototype.inSameChainInfront=function(t){for(var i=this.prev;null!=i;i=i.prev)if(i==t)return!0;return!1},t.prototype.inSameChainAfter=function(t){for(var i=this.next;null!=i;i=i.next)if(i==t)return!0;return!1},t.prototype.inSameChain=function(t){return this.inSameChainAfter(t)||this.inSameChainInfront(t)},t.prototype.setParentAll=function(t){this.parent=t,null!=this.next&&this.next.setParentAll(t)},t.prototype.getLowestMiddle=function(){return this.fp.getMiddleDelta(this.iFontSize)},t.prototype.getHighestMiddle=function(){return this.fp.getMiddleDelta(this.iFontSize)},t.prototype.getLowestMiddleAll=function(){var t=this.getLowestMiddle();if(null==this.next)return t;var i=this.next.getLowestMiddleAll();return i<t?i:t},t.prototype.getHighestMiddleAll=function(){var t=this.getHighestMiddle();if(null==this.next)return t;var i=this.next.getHighestMiddleAll();return t<i?i:t},t.prototype.left=function(t){return null!=this.prev?this.prev.cursorByLeft(t):t||null==this.parent?this:this.parent.cursorByLeftFromChild(this,t)},t.prototype.right=function(t){return null!=this.next?this.next.cursorByRight(t):t||null==this.parent?this:this.parent},t.prototype.cursorByLeft=function(t){return this},t.prototype.cursorByRight=function(t){return this},t.prototype.cursorByLeftFromChild=function(t,i){return this},t.prototype.down=function(t,i){var e;return t&&i==this||null==this.next||null==(e=this.next.cursorEnterDown())?null==this.parent?this:null!=(e=this.parent.cursorByDownFromChild(this,t,this.x+this.dim.w))?e:this:t?this.next:e},t.prototype.up=function(t,i){var e;return t&&i==this||null==this.next||null==(e=this.next.cursorEnterUp())?null==this.parent?this:null!=(e=this.parent.cursorByUpFromChild(this,t,this.x+this.dim.w))?e:this:t?this.next:e},t.prototype.cursorByDown=function(t,i){return i<this.x+this.dim.w||null==this.next?null==this.prev||this.x+this.dim.w/2<i?this:this.prev:this.next.cursorByDown(t,i)},t.prototype.cursorByUp=function(t,i){return i<this.x+this.dim.w||null==this.next?null==this.prev||this.x+this.dim.w/2<i?this:this.prev:this.next.cursorByUp(t,i)},t.prototype.cursorByDownFromChild=function(t,i,e){return null},t.prototype.cursorByUpFromChild=function(t,i,e){return null},t.prototype.cursorEnterUp=function(){return null},t.prototype.cursorEnterDown=function(){return null},t.prototype.fromXY=function(t,i){return t<this.x+this.dim.w||null==this.next?null==this.prev||this.x+this.dim.w/2<t?this:this.prev:this.next.fromXY(t,i)},t.prototype.toStringAll=function(t){return(this==t?"\\CURSOR":"")+this.toString(t)+(null!=this.next?this.next.toStringAll(t):"")},t.prototype.toMPadAll=function(){return this.toMPad()+(null!=this.next?this.next.toMPadAll():"")},t.prototype.containsBrackets=function(t){if(void 0===t)return null!=this.next?this.next.containsBrackets():0;if(null==this.next)return t;var i=this.next.containsBrackets();return i<t?t:i},t.prototype.drawRelLine=function(t,i,e,n,s,r){t.beginPath(),t.moveTo(i,e),t.lineTo(i+n,e+s),t.lineTo(i+n+r,e+s),t.lineTo(i+r,e),t.closePath(),t.fill()},t.correctAscent=function(t){return t},t.SIMPLE_DELETE=1,t.ENTER_UPDOWN=2,t}();e.Term=t}(fe||(fe={})),function(u){var t=function(){function h(t,i,e){void 0===i&&(i=null),void 0===e&&(e=0),this.canvas=t,this.width=-1,this.height=-1,this.resizeForced=!1,this.font=[],this.fontMetrics=[],this.baseFontSize=0,this.first=!0,this.factor=-1,this.baseline=-1,this.backgroundColor="#FFFFFF",this.foregroundColor="#000000",this.markColor="#C0C0C0",this.cursorColor="#000000",this.debug=!1,this.area=[],this.init(i,e),this.paint(this.canvas,!0)}return h.prototype.init=function(t,i){this.term=null!=t?u.TermFactory.readStringS1(t,this,null):new u.EmptyTerm(this,null),this.baseFontSize=i,this.d=new u.Dim(0,0,0),-1==this.factor&&(this.factor=window.devicePixelRatio);var e=this.canvas.getContext("2d");if(e.webkitBackingStorePixelRatio&&1<e.webkitBackingStorePixelRatio&&(this.factor=1),1<this.factor){var n=parseInt(this.canvas.getAttribute("width")),s=parseInt(this.canvas.getAttribute("height"));this.canvas.style.width=n+"px",this.canvas.style.height=s+"px",this.canvas.setAttribute("width",n*this.factor),this.canvas.setAttribute("height",s*this.factor)}for(var r=0;r<h.nFontType;r++){this.font[r]=[];for(var o=0;o<h.nFontSize;o++)this.font[r][o]=h.FontSize[o]*this.factor+"px "+h.FontType[r]}},h.prototype.calcDim=function(t){if(this.first){for(var i=0;i<h.nFontType;i++){this.fontMetrics[i]=[];for(var e=0;e<h.nFontSize;e++)this.fontMetrics[i][e]=new u.FontMetrics({fontFamily:h.FontType[i],fontSize:h.FontSize[e]*this.factor})}this.width=this.canvas.width,this.height=this.canvas.height,this.first=!1}this.d.copy(0,0,0),this.term.calcDimAll(this.baseFontSize,this.d,t),this.x=(this.width-this.d.w)/2,-1==this.baseline?this.y=(this.height-this.d.h1-this.d.h2)/2+this.d.h1:this.y=this.baseline},h.prototype.setDim=function(t,i,e){this.width=t,this.height=i,this.canvas.width=t,this.canvas.height=i,-1!=e&&(this.baseline=e),this.resizeForced=!0,this.repaint()},h.prototype.paint=function(t,i){this.calcDim(t);var e=t.getContext("2d");e.save(),i&&(e.fillStyle=this.getBackground(),e.fillRect(0,0,this.width,this.height));for(var n=0,s=this.area;n<s.length;n++){var r=s[n];e.fillStyle=r.c;var o=-1==r.x1?0:r.x1,h=-1==r.y1?0:r.y1;e.fillRect(o,h,(-1==r.x2?this.width:r.x2)-o,(-1==r.y2?this.height:r.y2)-h)}e.restore(),e.fillStyle=this.getForeground(),e.strokeStyle=this.getForeground(),this.term.paintAll(t,this.x,this.y)},h.prototype.repaint=function(){this.paint(this.canvas,!0)},h.prototype.setBackground=function(t){this.backgroundColor=t,this.canvas.style.background=t},h.prototype.getBackground=function(){return this.backgroundColor},h.prototype.setForeground=function(t){this.foregroundColor=t,this.canvas.style.color=t,this.cursorColor=t},h.prototype.setCursorColor=function(t){this.cursorColor=t},h.prototype.setMarkColor=function(t){this.markColor=t},h.prototype.getForeground=function(){return this.foregroundColor},h.prototype.getFont=function(t,i){return this.font[t][i]},h.prototype.getFontMetrics=function(t,i){return this.fontMetrics[t][i]},h.prototype.getFontDim=function(t,i){var e=this.getFontMetrics(t,i);return new u.Dim(u.Term.correctAscent(e.getAscent()),e.getDescent(),e.getAscent()/4)},h.prototype.getMiddleDelta=function(t){return this.fontMetrics[0][t].getAscent()/3},h.prototype.getLineThickness=function(t){return(2-t)/2*this.factor+1},h.prototype.getMPad=function(){return this.term.toMPadAll()},h.prototype.setValue=function(t){this.term=u.TermFactory.readStringS1(t,this,null)},h.prototype.requestRedim=function(){return-1!=this.baseline&&this.d.h1>this.baseline||-1==this.baseline&&this.d.h1+this.d.h2>this.height||this.d.w>this.width},h.prototype.addColorArea=function(t){this.area.push(t)},h.prototype.setCursor=function(t){},h.nFontType=2,h.nFontSize=5,h.FontType=["SansSerif","Lucida Sans Unicode"],h.FontSize=[18,13,8,3,1],h}();u.FormulaPanel=t}(fe||(fe={})),function(o){var t=function(r){function t(t,i){var e=r.call(this,t,i)||this;return e.toolbar=null,e.CaretVisible=!0,e.hasFocus=!1,e.smallCursor=!1,e.updownMark=!0,e.caretBlinks=!0,e.powIndKeys=!0,e.caretThread=null,e.touchId1=null,e.undoStack=[],e.undoPointer=-1,e.ensureKeyFocus=0,e.cursor=e.term,e.storeUndo(),t.addEventListener("mousedown",e.onMouseDown.bind(e)),t.addEventListener("mouseup",e.onMouseUp.bind(e)),t.addEventListener("mousemove",e.onMouseMove.bind(e)),t.addEventListener("focus",e.onFocus.bind(e)),t.addEventListener("touchstart",e.onTouchStart.bind(e)),t.addEventListener("touchmove",e.onTouchMove.bind(e)),t.addEventListener("touchend",e.onTouchEnd.bind(e)),e.caretBlinks&&(e.caretThread=window.setInterval(function(){e.CaretVisible=!e.CaretVisible,e.repaint()},500)),e.hiddenInput=document.createElement("input"),e.hiddenInput.type="text",e.hiddenInput.style.position="absolute",e.hiddenInput.style.opacity="0",e.hiddenInput.style.pointerEvents="none",e.hiddenInput.style.zIndex="0",e.hiddenInput.style.backgroundColor="#0F0",e.updateHiddenInput(),document.body.appendChild(e.hiddenInput),e.hiddenInput.addEventListener("keypress",e.onHiddenInputKeyPress.bind(e)),e.hiddenInput.addEventListener("keydown",e.onHiddenInputKeyDown.bind(e)),e.hiddenInput.addEventListener("blur",e.onHiddenInputBlur.bind(e)),navigator.userAgent.match(/Android/i)&&e.hiddenInput.addEventListener("input",e.onHiddenInputInput.bind(e)),e}return __extends(t,r),t.prototype.paint=function(t){-1!=this.width&&((n=t.getContext("2d")).save(),n.fillStyle=this.getBackground(),n.fillRect(0,0,this.width,this.height),n.restore());if(null!=this.markBegin){for(var i=this.markEnd,e=this.markEnd.dim.clone();null!=i.prev&&i.prev!=this.markBegin;)e.add((i=i.prev).dim);(n=t.getContext("2d")).save(),n.fillStyle=this.markColor,n.fillRect(this.markBegin.x+this.markBegin.dim.w,this.markBegin.y-e.h1,e.w,e.h1+e.h2),n.restore()}if(r.prototype.paint.call(this,t,!1),this.CaretVisible&&this.hasFocus){var n;(n=t.getContext("2d")).save(),n.fillStyle=this.cursorColor;var s=this.smallCursor?this.getFontDim(0,this.cursor.iFontSize):this.cursor.getCursorDim();n.beginPath(),n.moveTo(this.cursor.x+this.cursor.dim.w,this.cursor.y-s.h1),n.lineTo(this.cursor.x+this.cursor.dim.w,this.cursor.y+s.h2),n.stroke(),n.restore()}},t.prototype.setDim=function(t,i,e){r.prototype.setDim.call(this,t,i,e),this.updateHiddenInput()},t.prototype.onHiddenInputKeyDown=function(t){var i=t.key,e=t.shiftKey,n=this.cursor;"F3"==i&&e||"F12"==i&&t.ctrlKey||(90==t.keyCode&&(t.ctrlKey||t.metaKey)?this.undo():89==t.keyCode&&(t.ctrlKey||t.metaKey)?this.redo():"ArrowLeft"==i?(this.cursor=this.cursor.left(e),e&&(n==this.markBegin?this.markBegin=this.cursor:n==this.markEnd?this.markEnd=this.cursor:(this.markBegin=this.cursor,this.markEnd=n)),e&&this.markBegin!=this.markEnd||(this.markBegin=null,this.markEnd=null)):"ArrowRight"==i?(this.cursor=this.cursor.right(e),e&&(n==this.markBegin?this.markBegin=this.cursor:(n==this.markEnd||(this.markBegin=n),this.markEnd=this.cursor)),e&&this.markBegin!=this.markEnd||(this.markBegin=null,this.markEnd=null)):"ArrowDown"==i?(this.cursor=this.cursor.down(e,this.markBegin),e&&this.cursor!=n&&(this.updownMark?(this.markBegin=this.cursor.prev,this.markEnd=this.cursor,this.cursor=2*(n.x-this.cursor.x)>this.cursor.dim.w?this.cursor:this.cursor.prev):this.cursor=n),e&&this.markBegin!=this.markEnd||(this.markBegin=null,this.markEnd=null),t.preventDefault()):"ArrowUp"==i?(this.cursor=this.cursor.up(e,this.markBegin),e&&this.cursor!=n&&(this.updownMark?(this.markBegin=this.cursor.prev,this.markEnd=this.cursor,this.cursor=2*(n.x-this.cursor.x)>this.cursor.dim.w?this.cursor:this.cursor.prev):this.cursor=n),e&&this.markBegin!=this.markEnd||(this.markBegin=null,this.markEnd=null),t.preventDefault()):"Delete"==i&&null!=this.markBegin?this.deleteMark():"Delete"==i&&null!=this.cursor.next?0!=(this.cursor.next.getBehavior()&o.Term.SIMPLE_DELETE)?(this.cursor.next=this.cursor.next.next,null!=this.cursor.next&&(this.cursor.next.prev=this.cursor)):(this.markBegin=this.cursor,this.markEnd=this.cursor.next):"Backspace"==i&&null!=this.markBegin?this.deleteMark():"Backspace"==i&&(null!=this.cursor.prev&&0!=(this.cursor.getBehavior()&o.Term.SIMPLE_DELETE)?(this.cursor=this.cursor.prev,this.cursor.next=this.cursor.next.next,null!=this.cursor.next&&(this.cursor.next.prev=this.cursor)):null!=this.cursor.prev?(this.markBegin=this.cursor.prev,this.markEnd=this.cursor):null!=this.cursor.parent&&(this.markBegin=this.cursor.parent.prev,this.markEnd=this.cursor.parent))),this.repaint()},t.prototype.onHiddenInputKeyPress=function(t){if(t.preventDefault(),!t.ctrlKey&&!t.metaKey){var i=t.key;"^"==i&&this.powIndKeys?this.exec("new \\power#"):"_"==i&&this.powIndKeys?this.exec("new \\index#"):(null!=this.markBegin&&this.deleteMark(),this.cursor.insertAsNext(new o.SimpleTerm(this,this.cursor.parent,"*"==i?"\u2027":""+i,0)),this.cursor=this.cursor.next,this.repaint(),this.storeUndo())}},t.prototype.onHiddenInputInput=function(t){if(t.preventDefault(),""!=this.hiddenInput.value){null!=this.markBegin&&this.deleteMark();var i=this.hiddenInput.value;this.cursor.insertAsNext(new o.SimpleTerm(this,this.cursor.parent,"*"==i?"\u2027":""+i,0)),this.cursor=this.cursor.next,this.repaint(),this.hiddenInput.value="",this.storeUndo()}},t.prototype.deleteMark=function(){this.markBegin.next=this.markEnd.next,null!=this.markEnd.next&&(this.markEnd.next.prev=this.markBegin),this.cursor=this.markBegin,this.markBegin=null,this.markEnd=null},t.prototype.chainOutMark=function(t){var i=this.markBegin.next;return null==t?(this.markBegin.next=this.markEnd.next,null!=this.markEnd.next&&(this.markEnd.next.prev=this.markBegin)):((this.markBegin.next=t).prev=this.markBegin,t.next=this.markEnd.next,null!=this.markEnd.next&&(this.markEnd.next.prev=t),t.parent=this.markBegin.parent),i.prev=null,this.markEnd.next=null,this.markBegin=null,this.markEnd=null,i},t.prototype.exec=function(t){if(o.StrUtil.startsWith(t,"new ")){(o.StrUtil.startsWith(t,"new \\lindex")||o.StrUtil.startsWith(t,"new \\lpower")||o.StrUtil.startsWith(t,"new \\lpowind"))&&(null!=this.markBegin?this.cursor=this.markBegin:null!=this.cursor.prev&&(this.cursor=this.cursor.prev),this.markBegin=null),null!=this.markBegin&&(this.cursor=this.markBegin);var i=null!=this.markBegin?this.chainOutMark(null):null,e=o.TermFactory.readStringS2(t.substring(4),this,this.cursor.parent,i).next;if(null==e)return;var n=e.last();this.cursor.insertChainAsNext(e),0==e.getNCon()?this.cursor=n.cursorByLeft(!1):this.cursor=e.getCon(1<e.getNCon()&&null!=i&&-1!=t.indexOf("#")?1:0).last().cursorByLeft(!1),this.repaint(),this.storeUndo()}},t.prototype.onPointerDown=function(t,i,e){void 0===e&&(e=!0),this.ensureKeyFocus=0,this.hasFocus||this.requestFocus(),this.d.isIn(t-this.x,i-this.y)?this.cursor=this.term.fromXY(t,i):t<this.x?this.cursor=this.term:this.x+this.d.w<t&&(this.cursor=this.term.last().cursorByLeft(!1)),e&&(this.mouseMark=!0,this.markBegin=null,this.mouseMarkTerm1=this.cursor),this.repaint()},t.prototype.onPointerUp=function(){this.mouseMark=!1},t.prototype.onPointerMove=function(t,i){if(this.d.isIn(t-this.x,i-this.y)&&this.mouseMark){if(this.cursor=this.term.fromXY(t,i),this.mouseMarkTerm2=this.cursor,this.mouseMarkTerm1==this.mouseMarkTerm2)this.markBegin=this.cursor.prev,this.markEnd=this.cursor;else{for(var e=o.TermChainer.MakeTermChainer(this.mouseMarkTerm1),n=o.TermChainer.MakeTermChainer(this.mouseMarkTerm2);e.term==n.term&&null!=e.next&&null!=n.next;)e=e.next,n=n.next;if(null==e.next&&e.term==n.term){var s=e.term;this.markBegin=null!=s.prev?s.prev:s,this.markEnd=s,this.cursor=this.markBegin}else if(null==n.next&&e.term==n.term){s=n.term;this.markBegin=null!=s.prev?s.prev:s,this.markEnd=s,this.cursor=this.markEnd}else if(e.term.inSameChainInfront(n.term))this.markBegin=null!=n.next&&null!=n.term.prev?n.term.prev:n.term,this.markEnd=e.term,this.cursor=this.markBegin;else if(e.term.inSameChainAfter(n.term))this.markBegin=null!=e.next&&null!=e.term.prev?e.term.prev:e.term,this.markEnd=n.term,this.cursor=this.markEnd;else{s=e.term.parent;this.markBegin=null!=s.prev?s.prev:s,this.markEnd=s,this.cursor=s}}this.repaint()}},t.prototype.onMouseDown=function(t){t.preventDefault(),this.onPointerDown(t.offsetX*this.factor,t.offsetY*this.factor,0==t.button)},t.prototype.onMouseUp=function(t){t.preventDefault(),this.onPointerUp()},t.prototype.onMouseMove=function(t){t.preventDefault(),this.onPointerMove(t.offsetX*this.factor,t.offsetY*this.factor)},t.prototype.onTouchStart=function(t){if(1==t.touches.length){var i=t.changedTouches[0],e=this.canvas.getBoundingClientRect();this.onPointerDown((i.pageX-e.left)*this.factor,(i.pageY-e.top)*this.factor),this.touchId1=i.identifier,t.stopPropagation(),t.preventDefault()}},t.prototype.onTouchMove=function(t){if(1==t.touches.length&&t.touches.item(0).identifier==this.touchId1){var i=t.touches[0],e=this.canvas.getBoundingClientRect();this.onPointerMove((i.pageX-e.left)*this.factor,(i.pageY-e.top)*this.factor),t.preventDefault()}},t.prototype.onTouchEnd=function(t){if(null!=this.touchId1){for(var i=0;i<t.touches.length;i++){if(t.touches.item(i).identifier==this.touchId1)return}this.onPointerUp(),this.touchId1=null}},t.prototype.onFocus=function(t){this.preventCloseToolbar(),this.hasFocus=!0,null==this.toolbar||this.toolbar.isVisible()||this.toolbar.setVisible(!0),this.hiddenInput.focus()},t.prototype.onHiddenInputBlur=function(t){null!=this.toolbar&&this.toolbar.isVisible()&&this.closeToolbar(),this.hasFocus=!1},t.prototype.closeToolbar=function(){var t=this;this.doCloseToolbar=!0,setTimeout(function(){t.doCloseToolbar&&(t.toolbar.setVisible(!1),t.doCloseToolbar=!1)},500)},t.prototype.preventCloseToolbar=function(){this.doCloseToolbar=!1},t.prototype.requestFocus=function(){this.canvas.focus()},t.prototype.updateHiddenInput=function(){var t=o.ElementUtils.getAbsDim(this.canvas);this.hiddenInput.style.left=t.x+"px",this.hiddenInput.style.top=t.y+"px",this.hiddenInput.style.width=t.w+"px",this.hiddenInput.style.height=t.h+"px"},t.prototype.storeUndo=function(){var t=this.term.toStringAll(this.cursor);0<this.undoStack.length&&this.undoStack[this.undoPointer].replace("\\CURSOR","")==t.replace("\\CURSOR","")||(this.undoStack[++this.undoPointer]=t,this.undoStack=this.undoStack.slice(0,this.undoPointer+1))},t.prototype.undo=function(){this.undoPointer<=0||(this.term=o.TermFactory.readStringS1(this.undoStack[--this.undoPointer],this,null))},t.prototype.redo=function(){this.undoPointer>=this.undoStack.length-1||(this.term=o.TermFactory.readStringS1(this.undoStack[++this.undoPointer],this,null))},t.prototype.setCursor=function(t){this.cursor=t},t.prototype.deb=function(t){var i=document.getElementById("debug");i.innerHTML=t+"<br/>"+i.innerHTML},t}(o.FormulaPanel);o.FormulaField=t}(fe||(fe={})),function(u){var t=function(){function t(t,i){void 0===i&&(i={}),this.ff=null,this.fp=null,this.toolbar=null,this.oldStyle=!0,this.assetsPath="assets/",this.oldStyle=this.booleanPara(i.oldstyle,this.oldStyle);var e=i.value;if(null==e&&null!=(e=i.mpad)&&(e=u.MathePadConverter.toFormula(e,this.oldStyle)),this.fp=i.noedit?new u.FormulaPanel(t,e):this.ff=new u.FormulaField(t,e),null!=this.ff&&(this.ff.smallCursor=this.booleanPara(i.smallcursor,!1),this.ff.updownMark=this.booleanPara(i.updownmark,!0),this.ff.caretBlinks=this.booleanPara(i.caretblinks,!0),this.ff.powIndKeys=this.booleanPara(i.powindkeys,!0),i.assets&&(this.assetsPath=i.assets)),i.bgcolor&&this.fp.setBackground(i.bgcolor),i.fgcolor&&this.fp.setForeground(i.fgcolor),i.cursorcolor&&this.fp.setCursorColor(i.fgcolor),i.markcolor&&this.fp.setMarkColor(i.fgcolor),this.fp.debug=this.booleanPara(i.debug,!1),i.factor&&("NO"==(""+i.factor).toUpperCase()?this.fp.factor=1:this.fp.factor=parseInt(i.factor)),null!=i.area&&"object"==typeof i.area)if("object"==typeof i.area[0])for(var n=0,s=i.area;n<s.length;n++){var r=s[n];this.fp.addColorArea(new u.ColorArea(r))}else this.fp.addColorArea(new u.ColorArea(i.area));if(this.fp.repaint(),null!=this.ff){for(var o=[],h=0;h++&&i["menu"+h];)o.push(i["menu"+h]);this.toolbar=new u.Toolbar(this.ff,this.assetsPath,this.oldStyle,o,i.menutitle||"Tools"),this.toolbar.setVisible(!0),t.focus()}}return t.prototype.booleanPara=function(t,i){return null==t||null==t?i:"1"==(t=t.toLowerCase())||"yes"==t||"true"==t||"0"!=t&&"no"!=t&&"false"!=t&&i},t.prototype.getMPad=function(){return this.fp.getMPad()},t.prototype.setMPad=function(t){this.fp.setValue(u.MathePadConverter.toFormula(t,this.oldStyle)),this.fp.repaint()},t.prototype.setBGColor=function(t){this.fp.setBackground(t),this.fp.repaint()},t.prototype.getBGColor=function(){return this.fp.getBackground()},t.prototype.setDim=function(t,i,e){return this.fp.setDim(t,i,e),this.requestRedim()},t.prototype.getDim=function(){return this.fp.d.w+","+this.fp.d.h1+","+this.fp.d.h2},t.prototype.getYPositionOnScreen=function(){return this.fp.canvas.getBoundingClientRect().top},t.prototype.requestRedim=function(){return this.fp.requestRedim()?this.getDim():""},t.calcAppletSizeMPad=function(t,i,e){var n=document.createElement("canvas"),s=new u.FormulaPanel(n,u.MathePadConverter.toFormula(t,!1));return s.calcDim(n),'width="'+(s.d.w+i)+'" height="'+(s.d.h1+s.d.h2+e)+'"'},t.calcDimMPad=function(t){var i=document.createElement("canvas"),e=new u.FormulaPanel(i,u.MathePadConverter.toFormula(t,!1));return e.calcDim(i),e.d.w+","+e.d.h1+","+e.d.h2},t}();u.Fe=t}(fe||(fe={})),function(t){var i=function(){function t(t,i,e,n){void 0===n&&(n=""),this.name=t,this.priority=i,this.trans=e,this.symbol=n}return t.prototype.getTrans=function(t){return t&&""!=this.symbol?"FONT1"+this.symbol:this.trans},t}();t.MCode=i}(fe||(fe={})),function(t){var i=function(){function t(){}return t.startsWith=function(t,i,e){return void 0===e&&(e=0),t.indexOf(i,e)==e},t.endsWith=function(t,i,e){void 0===e&&(e=0);var n=t.length,s=i.length;return s<=n&&t.substr(n-s)==i},t}();t.StrUtil=i}(fe||(fe={})),function(U){var t=function(){function _(){}return _.Replace=function(t,i,e){for(var n,s="",r=0;r<t.length&&-1!=(n=t.indexOf(i,r));)s+=t.substring(r,n),s+=e,r=n+i.length;return r<t.length&&(s+=t.substring(r)),s},_.HTML2MetaHTML=function(t){var i=_.Replace(t,"&auml;","\xe4");return i=_.Replace(i,"&ouml;","\xf6"),i=_.Replace(i,"&uuml;","\xfc"),i=_.Replace(i,"&Auml;","\xc4"),i=_.Replace(i,"&Ouml;","\xd6"),i=_.Replace(i,"&Uuml;","\xdc"),i=_.Replace(i,"&szlig;","\xdf")},_.toFormula=function(t,i){for(var e=_.Text2mh(_.Replace(_.Replace(_.Replace(_.Replace(_.Replace(_.HTML2MetaHTML(t),"\\upsilon","\\ypsilon"),"\\upsih","\\ypsih"),"\\infin","\\irfin"),"&lt;","<"),"&gt;",">"),i),n=0;n<_.mChar.length;n+=2)e=_.Replace(e,_.mChar[n],_.mChar[n+1]);return e=_.Replace(e,"\\irfin","\u221e"),e=_.Replace(e,"\\","\\\\"),e=_.Replace(e,"@","\\")},_.GetIndExp=function(t,i,e){var n=i;if(99999==e&&(e=t.length),e<=i)return n;var s=0,r=0,o=0,h=0;do{var u=t.charAt(n);"("==u?s++:")"==u?0<s&&s--:"["==u?r++:"]"==u?0<r&&r--:"\\"==u&&0<n&&"{"==t.charAt(n+1)?(h++,n++):"\\"==u&&0<n&&"}"==t.charAt(n-1)?(0<h&&h--,n++):"{"==u?o++:"}"==u&&0<o&&o--,n++}while(n<e&&(0!=s||0!=r||0!=o||0!=h));return n},_.Text2mh=function(t,i){for(var e="",n=t;0<n.length&&" "==n.charAt(0);)n=n.substring(1);for(;0<n.length&&" "==n.charAt(n.length-1);)n=n.substring(0,n.length-1);if(""==n)return e;for(var s=n.length-1,r=s,o=-1,h=100,u=0,d=0,l=0,a=0,c=99999,p=99999,f=99999,m=99999,y=99999,g=99999,w=99999,v=99999,x=99999,M=99999;0<=s;){var T=n.charAt(s);if(")"==T)u++,99999==p&&(p=s);else if("("==T)0<u&&u--,99999==c&&0==u&&(c=s);else if("]"==T)d++,99999==m&&(m=s);else if("["==T)0<d&&d--,99999==f&&0==d&&(f=s);else if("}"==T&&0<s&&"\\"==n.charAt(s-1))a++,99999==v&&(v=s);else if("{"==T&&0<s&&"\\"==n.charAt(s-1))0<a&&a--,99999==w&&0==a&&(w=s);else if("}"==T)l++,99999==g&&(g=s);else if("{"==T)0<l&&l--,99999==y&&0==l&&(y=s);else if(0==u&&0==l&&0==d&&0==a){for(var b=0;b<_.mCode.length;b++)U.StrUtil.startsWith(n,_.mCode[b].name,s)&&_.mCode[b].priority<h&&(h=_.mCode[b].priority,r=s,o=b);1==o&&0<r&&"<"==n.charAt(r-1)&&(r--,o++),"^"==T&&99999==x&&(x=s),"_"==T&&99999==M&&(M=s)}s--}if(100!=h&&9!=h){var C=_.Text2mh(n.substring(0,r),i),k=_.Text2mh(n.substring(r+_.mCode[o].name.length),i),B=_.mCode[o].getTrans(i);e=U.StrUtil.startsWith(B,"2R")?B.substring(2)+"{"+k+"}{"+C+"}":U.StrUtil.startsWith(B,"2")?B.substring(1)+"{"+C+"}{"+k+"}":U.StrUtil.startsWith(B,"1")?C+B.substring(1)+"{"+k+"}":C+B+k}else if(9==h){var F=x<M?x:M,S=void 0,A=void 0,P=_.Text2mh(n.substring(0,F),i),D="",E="",L="",I="";if(99999!=M){if((S=_.GetIndExp(n,M+1,x<M?99999:x))!=x&&S!=n.length)return _.Text2mh(n.substring(0,S),i)+_.Text2mh(n.substring(S),i);D=n.substring(M+1,S),L=_.Text2mh(D,i)}if(99999!=x){if((A=_.GetIndExp(n,x+1,M<x?99999:M))!=M&&A!=n.length)return _.Text2mh(n.substring(0,A),i)+_.Text2mh(n.substring(A),i);E=n.substring(x+1,A),I=_.Text2mh(E,i)}e=""==D?P+"^{"+_.Text2mh(E,i)+"}":""==E?P+"_{"+_.Text2mh(D,i)+"}":P+"@powind{"+I+"}{"+L+"}"}else{var R=-1;if(99999!=c&&9999!=p&&R<p&&(R=p),99999!=y&&9999!=g&&R<g&&(R=g),99999!=f&&9999!=m&&R<m&&(R=m),99999!=w&&9999!=v&&R<v&&(R=v),p<R&&(p=99999),g<R&&(g=99999),m<R&&(m=99999),v<R&&(v=99999),99999!=c&&99999!=p)e=_.DoBracket(n,c,p,0,0,i);else if(99999!=f&&99999!=m)e=_.DoBracket(n,f,m,0,1,i);else if(99999!=w&&99999!=v)e=_.DoBracket(n,w,v,1,2,i);else if(99999!=y&&99999!=g){C=_.Text2mh(n.substring(0,y),i);if(g<y)return C+"{"+_.Text2mh(n.substring(y+1),i);e=C+_.Text2mh(n.substring(y+1,g),i)+(k=_.Text2mh(n.substring(g+1),i))}else e=n}return e},_.DoBracket=function(t,i,e,n,s,r){var o=_.Text2mh(t.substring(0,i-n),r);return e<i?o+"@bracket"+s+"{"+_.Text2mh(t.substring(i+1),r)+"}":o+"@bracket"+s+"{"+_.Text2mh(t.substring(i+1,e-n),r)+"}"+_.Text2mh(t.substring(e+1),r)},_.mCode=[new U.MCode("=>",0,"\u21d2"),new U.MCode("<=>",0,"\u21d4"),new U.MCode(";",0,"; "),new U.MCode("\\in",0,"\u220a"),new U.MCode("\\notin",0,"\u2209"),new U.MCode("\\subset",2,"\u2282"),new U.MCode("\\subseteq",1,"\u2286"),new U.MCode("\\supset",2,"\u2283"),new U.MCode("\\supseteq",1,"\u2287"),new U.MCode("\\notsubset",2,"\u2284"),new U.MCode("\\all",2,"\u2200"),new U.MCode("\\exist",2,"\u2203"),new U.MCode("<=",3,"\u2264"),new U.MCode(">=",3,"\u2265"),new U.MCode("\\asymp",4,"\u2248"),new U.MCode("\\to",4,"\u2192"),new U.MCode("=",4," = "),new U.MCode("\\ne",4,"\u2260"),new U.MCode("<",4," < "),new U.MCode(">",4," > "),new U.MCode("| ",4,"| "),new U.MCode("|",4,"|"),new U.MCode("\\over",4,"2@above"),new U.MCode("\\cup",5,"\u22c3"),new U.MCode("\\cap",6,"\u22c2"),new U.MCode("+",7,"+"),new U.MCode("-",7,"-"),new U.MCode("\\pm",7,"\xb1"),new U.MCode("\\mp",7,"\u2213"),new U.MCode("*",8,"\u2027"),new U.MCode(": ",8,": "),new U.MCode(":",8,":"),new U.MCode("/",8,"2@frac"),new U.MCode("_",9,"_"),new U.MCode("^",9,"^"),new U.MCode("\\root",10,"1@root"),new U.MCode("\\nroot",10,"2R@rootn"),new U.MCode("\\per",10,"1@overline"),new U.MCode("\\u",10,"1@underline"),new U.MCode("\\du",10,"1@dunderline")],_.mChar=["\\null","\u2205","\\sigmaf","\u03c2","\\thetasym","\u03d1","\\ypsih","\u03d2","\\asterisk","\u22c6","\\Alpha","\u0391","\\Beta","\u0392","\\Gamma","\u0393","\\Delta","\u0394","\\Epsilon","\u0395","\\Zeta","\u0396","\\Eta","\u0397","\\Theta","\u0398","\\Iota","\u0399","\\Kappa","\u039a","\\Lambda","\u039b","\\Mu","\u039c","\\Nu","\u039d","\\Xi","\u039e","\\Omicron","\u039f","\\Pi","\u03a0","\\Rho","\u03a1","\\Sigma","\u03a3","\\Tau","\u03a4","\\Upsilon","\u03a5","\\Phi","\u03a6","\\Chi","\u03a7","\\Psi","\u03a8","\\Omega","\u03a9","\\alpha","\u03b1","\\beta","\u03b2","\\gamma","\u03b3","\\delta","\u03b4","\\epsilon","\u03b5","\\zeta","\u03b6","\\eta","\u03b7","\\theta","\u03b8","\\iota","\u03b9","\\kappa","\u03ba","\\lambda","\u03bb","\\mu","\u03bc","\\nu","\u03bd","\\xi","\u03be","\\omicron","\u03bf","\\pi","\u03c0","\\rho","\u03c1","\\sigma","\u03c3","\\tau","\u03c4","\\ypsilon","\u03c5","\\phi","\u03c6","\\chi","\u03c7","\\psi","\u03c8","\\omega","\u03c9","\\C","\u2102","\\N","\u2115","\\P","\u2119","\\Q","\u211a","\\R","\u211d","\\Z","\u2124","\\L","\u2124"],_}();U.MathePadConverter=t}(fe||(fe={})),function(t){var i=function(){function t(t,i,e,n,s){var r=this;this.tb=t,this.actionCommand=n,this.subMenu=s,this.active=!1,this.tb=t,this.actionCommand=n,this.subMenu=s,this.button=document.createElement("button"),this.button.style.width=i+4+"px",this.button.style.height=e+4+"px",s&&-1!=s&&(this.button.id="fe_menu_"+s),this.button.addEventListener("click",function(){-1!=r.subMenu?t.openSubMenu(r.subMenu):t.choosen(n)})}return t.border=1,t}();t.MenuField=i}(fe||(fe={})),function(u){var t=function(h){function t(t,i,e,n,s,r){var o=h.call(this,t,i,e,n,s)||this;return o.button.innerHTML='<canvas width="'+i+'" heiht="'+e+'"></canvas/>',o.panel=new u.FormulaPanel(o.button.getElementsByTagName("canvas")[0],r,1),o}return __extends(t,h),t}(u.MenuField);u.FormulaMenuField=t}(fe||(fe={})),function(t){var i=function(h){function t(t,i,e,n,s,r){var o=h.call(this,t,i,e,n,s)||this;return o.button.innerHTML='<img src="'+r+'" valign="middle"/>',o}return __extends(t,h),t}(t.MenuField);t.ImageMenuField=i}(fe||(fe={})),function(t){var i=function(){function t(t,i,e){void 0===e&&(e=!1),this.tb=t,this.width=i,this.div=document.createElement("div"),this.div.classList.add("fe-toolbar-popup"),this.div.style.width=i+"px"}return t.prototype.setVisible=function(t,i){null==this.div.parentElement&&document.body.appendChild(this.div),this.div.style.display=t?"block":"none",null!=i&&this.setPosition(i)},t.prototype.setPosition=function(t){this.div.style.top=t.top+t.height+(document.body.scrollTop||document.documentElement.scrollTop)+"px",this.div.style.left=t.left+(document.body.scrollLeft||document.documentElement.scrollLeft)+"px"},t.prototype.add=function(t){this.div.appendChild(t.button)},t.border=1,t}();t.PopupMenu=i}(fe||(fe={})),function(t){var i=function(h){function t(t,i,e,n,s,r){var o=h.call(this,t,i,e,n,s)||this;return o.button.innerHTML=r,o}return __extends(t,h),t}(t.MenuField);t.TextMenuField=i}(fe||(fe={})),function(l){var t=function(){function t(t,i,e,n,s){if(void 0===n&&(n=null),void 0===s&&(s="Tools"),this.fp=t,this.assetPath=i,this.oldStyle=e,this.nMenu=0,this.menu=[],this.popup=[],this.lastFocusedMenuField=null,this.subMenu=-1,this.noticesFocus=!1,this.movingDx=-1,this.movingDy=-1,this.touchId1=null,t.toolbar=this,!window.feCssInserted){var r=document.createElement("link");r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("href",i+"fe.css"),document.getElementsByTagName("head")[0].appendChild(r),window.feCssInserted=!0}this.div=document.createElement("div"),this.div.classList.add("fe-toolbar"),this.div.innerHTML='<div class="fe-title">'+s+"</div>",this.menuFieldArea=document.createElement("div"),this.div.appendChild(this.menuFieldArea),null!=n&&0!=n.length||(n=["standard"]);for(var o=0;o<n.length;o++){if("frac"==n[o]||"standard"==n[o])this.add(this.menu[this.nMenu]=new l.ImageMenuField(this,36,24,"",this.nMenu,i+"fracroot.gif")),(h=this.popup[this.nMenu++]=this.newPopup(68)).add(new l.ImageMenuField(this,30,20,"new \\frac#",-1,i+"frac.gif")),h.add(new l.ImageMenuField(this,30,20,"new \\above#",-1,i+"above.gif")),h.add(new l.ImageMenuField(this,30,20,"new \\root#",-1,i+"root2.gif")),h.add(new l.ImageMenuField(this,30,20,"new \\rootn#",-1,i+"rootn.gif"));if("index"!=n[o]&&"standard"!=n[o]||this.addMenu("72 'powind.gif' 36 24 'ind.gif' 'new \\index#' 20 20 'pow.gif' 'new \\power#' 'powind.gif' 'new \\powind#' 'lind.gif' 'new \\lindex#' 'lpow.gif' 'new \\lpower#' 'lpowind.gif' 'new \\lpowind#' 'top.gif' 'new \\over#' 'bot.gif' 'new \\under#' 'topbot.gif' 'new \\overunder#'"),"brackets"==n[o]||"standard"==n[o]){this.add(this.menu[this.nMenu]=new l.ImageMenuField(this,36,24,"",this.nMenu,i+"brackets.gif"));for(var h=this.popup[this.nMenu++]=this.newPopup(96),u=0;u<8;u++)h.add(new l.ImageMenuField(this,20,20,"new \\bracket"+u+"#",-1,i+"br"+u+".gif"))}if("greek"==n[o]||"standard"==n[o]){this.add(this.menu[this.nMenu]=new l.TextMenuField(this,36,24,"",this.nMenu,"\u03b1 \u03c9"));for(var h=this.popup[this.nMenu++]=this.newPopup(96),d=945;d<=969;d++)h.add(new l.TextMenuField(this,20,20,"new "+String.fromCharCode(d),-1,String.fromCharCode(d)));h.add(new l.TextMenuField(this,20,20,"new \u03d1",-1,"\u03d1")),h.add(new l.TextMenuField(this,20,20,"new \u03d2",-1,"\u03d2")),h.add(new l.TextMenuField(this,20,20,"new \u03d6",-1,"\u03d6"))}if("GREEK"==n[o]||"standard"==n[o]){this.add(this.menu[this.nMenu]=new l.TextMenuField(this,36,24,"",this.nMenu,"\u0391 \u03a9"));for(h=this.popup[this.nMenu++]=this.newPopup(96),d=913;d<=937;d++)930!=d&&h.add(new l.TextMenuField(this,20,20,"new "+String.fromCharCode(d),-1,String.fromCharCode(d)))}if("special"==n[o]||"standard"==n[o])this.add(this.menu[this.nMenu]=new l.TextMenuField(this,36,24,"",this.nMenu,"\u2264 \u2260")),(h=this.popup[this.nMenu++]=this.newPopup(120)).add(new l.TextMenuField(this,20,20,"new \u2264",-1,"\u2264")),h.add(new l.TextMenuField(this,20,20,"new \u2265",-1,"\u2265")),h.add(new l.TextMenuField(this,20,20,"new \u227a",-1,"\u227a")),h.add(new l.TextMenuField(this,20,20,"new \u227b",-1,"\u227b")),h.add(new l.TextMenuField(this,20,20,"new \u2260",-1,"\u2260")),h.add(new l.TextMenuField(this,20,20,"new \u2261",-1,"\u2261")),h.add(new l.TextMenuField(this,20,20,"new \u2248",-1,"\u2248")),h.add(new l.TextMenuField(this,20,20,"new \u2245",-1,"\u2245")),h.add(new l.TextMenuField(this,20,20,"new \xb1",-1,"\xb1")),h.add(new l.TextMenuField(this,20,20,"new \u2213",-1,"\u2213"));"arrows"!=n[o]&&"standard"!=n[o]||this.addMenu("72 '\u2192\u21d4\u2193' 36 24 '\u2192' 'new \u2192' 20 20 '\u2190' 'new \u2190' '\u2194' 'new \u2194' '\u2191' 'new \u2191' '\u2193' 'new \u2193' '\u2195' 'new \u2195' '\u21d2' 'new \u21d2' '\u21d0' 'new \u21d0' '\u21d4' 'new \u21d4' '\u21d1' 'new \u21d1' '\u21d3' 'new \u21d3' '\u21d5' 'new \u21d5' '\u21a6' 'new \u21a6' '\u21b2' 'new \u21b2'"),l.StrUtil.startsWith(n[o],"menu ")&&this.addMenu(n[o].substring(5))}this.div.addEventListener("mousedown",this.onMouseDown.bind(this)),this.div.addEventListener("mouseup",this.onMouseUp.bind(this)),this.div.addEventListener("mousemove",this.onMouseMove.bind(this)),this.div.addEventListener("touchstart",this.onTouchStart.bind(this)),this.div.addEventListener("touchmove",this.onTouchMove.bind(this)),this.div.addEventListener("touchend",this.onTouchEnd.bind(this))}return t.prototype.newPopup=function(t){return this.oldStyle?new l.PopupMenu(this,t,!0):new l.PopupMenu(this,t)},t.prototype.add=function(t){this.menuFieldArea.appendChild(t.button)},t.prototype.addMenu=function(t){var i=t,e=60,n=20;if(!/^(\d+)\s+(.*)$/.test(i))throw new Error("Can not interpret menu string '"+i+"'.");e=parseInt(RegExp.$1),i=RegExp.$2;for(var s=this.newPopup(e),r=!0;""!=i;){if(!(r?/^('[^']+'|\S+)()\s+(\d+|)\s*(\d+|)\s*(.*)$/:/^('[^']+'|\S+)\s+('[^']+'|\S+)\s*(\d+|)\s*(\d+|)\s*(.*)$/).test(i))throw new Error("Can not interpret menu string part '"+i+"'.");var o=RegExp.$1,h=RegExp.$2;RegExp.$3&&(e=parseInt(RegExp.$3)),RegExp.$4&&(n=parseInt(RegExp.$4)),i=RegExp.$5,2<o.length&&"'"==o.charAt(0)&&"'"==o.charAt(o.length-1)&&(o=o.substr(1,o.length-2)),2<h.length&&"'"==h.charAt(0)&&"'"==h.charAt(h.length-1)&&(h=h.substr(1,h.length-2));var u=void 0;u=l.StrUtil.endsWith(o,".gif")?new l.ImageMenuField(this,e,n,h,-1,this.assetPath+o):l.StrUtil.startsWith(o,"fe:")?new l.FormulaMenuField(this,e,n,h,-1,o.substr(3)):new l.TextMenuField(this,e,n,h,-1,o),r?(u.subMenu=this.nMenu,this.add(this.menu[this.nMenu]=u),this.popup[this.nMenu++]=s,r=!1):s.add(u)}},t.prototype.openSubMenu=function(t){this.fp.requestFocus();var i=this.subMenu;this.closeSubMenu(),i!=t&&(this.menu[t].active=!0,this.menu[t].button.classList.add("pressed"),this.setVisible(!0),this.popup[this.subMenu=t].setVisible(!0,this.menu[t].button.getBoundingClientRect()))},t.prototype.closeSubMenu=function(){-1!=this.subMenu&&(this.menu[this.subMenu].button.classList.remove("pressed"),this.popup[this.subMenu].setVisible(!1),this.menu[this.subMenu].active=!1,this.subMenu=-1)},t.prototype.choosen=function(t){this.fp.requestFocus(),this.closeSubMenu(),this.lastFocusedMenuField=null,this.fp.exec(t)},t.prototype.setVisible=function(t){if(null==this.div.parentElement){document.body.appendChild(this.div);var i=l.ElementUtils.getAbsDim(this.fp.canvas),e={w:document.body.clientWidth,h:document.body.clientHeight},n={w:280,h:this.div.clientHeight},s=document.body.scrollLeft||document.documentElement.scrollLeft,r=document.body.scrollTop||document.documentElement.scrollTop,o=i.x-s,h=e.w-(i.x-s+i.w),u=i.x-s+i.w+8,d=i.y-r;if(h<n.w+8)if(h<o){if((u=i.x-s-n.w-8)<-n.w-8)20<r+e.h-i.y-i.h?(u=i.x-s+(i.w-n.w)/2,d=i.y-r+i.h+8):u=i.x-s}else if(h<150){20<r+e.h-i.y-i.h&&(u=i.x-s+(i.w-n.w)/2,d=i.y-r+i.h+8)}this.div.style.left=u+s+"px",this.div.style.top=d+r+"px"}this.div.style.display=t?"block":"none",t||-1==this.subMenu||this.closeSubMenu()},t.prototype.isVisible=function(){return null!=this.div.parentElement&&"none"!=this.div.style.display},t.prototype.onMouseDown=function(t){t.preventDefault();var i=this.div.getBoundingClientRect();this.movingDx=t.clientX-i.left-(document.body.scrollLeft||document.documentElement.scrollLeft),this.movingDy=t.clientY-i.top-(document.body.scrollTop||document.documentElement.scrollTop),this.fp.requestFocus()},t.prototype.onMouseMove=function(t){t.preventDefault(),-1!=this.movingDx&&(this.div.style.left=-this.movingDx+t.clientX+"px",this.div.style.top=-this.movingDy+t.clientY+"px",-1!=this.subMenu&&this.popup[this.subMenu].setPosition(this.menu[this.subMenu].button.getBoundingClientRect()))},t.prototype.onMouseUp=function(t){t.preventDefault(),this.movingDx=-1},t.prototype.onTouchStart=function(t){var i=this.div.getBoundingClientRect(),e=t.changedTouches[0];this.movingDx=e.clientX-i.left-(document.body.scrollLeft||document.documentElement.scrollLeft),this.movingDy=e.clientY-i.top-(document.body.scrollTop||document.documentElement.scrollTop),this.fp.requestFocus(),this.touchId1=e.identifier},t.prototype.onTouchMove=function(t){if(-1!=this.movingDx){for(var i=0;i<t.changedTouches.length;i++){var e=t.changedTouches.item(i);e.identifier==this.touchId1&&(this.div.style.left=-this.movingDx+e.clientX+"px",this.div.style.top=-this.movingDy+e.clientY+"px",-1!=this.subMenu&&this.popup[this.subMenu].setPosition(this.menu[this.subMenu].button.getBoundingClientRect()))}t.preventDefault()}},t.prototype.onTouchEnd=function(t){if(null!=this.touchId1){for(var i=0;i<t.touches.length;i++){if(t.touches.item(i).identifier==this.touchId1)return}this.movingDx=-1,this.touchId1=null}},t}();l.Toolbar=t}(fe||(fe={})),function(n){var t=function(e){function t(t,i){return e.call(this,t,i)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){var e=this.fp.getFontMetrics(0,this.iFontSize);this.dim.h1=n.Term.correctAscent(e.getAscent()),this.dim.h2=e.getDescent(),this.dim.w=null==this.next&&null==this.prev?e.getAscent()/4:0},t.prototype.paint=function(t,i,e){if(null==this.next){var n=t.getContext("2d");n.save(),n.fillStyle="#C0C0C0",n.fillRect(i,e-this.dim.h1,this.dim.w,this.dim.h1+this.dim.h2),n.restore()}},t.prototype.toString=function(){return""},t.prototype.toMPad=function(){return""},t}(n.Term);n.EmptyTerm=t}(fe||(fe={})),function(r){var t=function(s){function t(t,i,e){var n=s.call(this,t,i)||this;return n.mainIsTop=!0,n.con1=new r.EmptyTerm(t,n),n.con2=new r.EmptyTerm(t,n),n.d1=new r.Dim,n.d2=new r.Dim,n.mainIsTop=e,n}return __extends(t,s),t.prototype.getNCon=function(){return 2},t.prototype.setCon=function(t,i){0==i?(this.con1=t,this.con1.setParentAll(this)):1==i&&(this.con2=t,this.con2.setParentAll(this))},t.prototype.getCon=function(t){return 0==t?this.con1:1==t?this.con2:null},t.prototype.getBehavior=function(){return r.Term.ENTER_UPDOWN},t.prototype.getUpper=function(){return this.mainIsTop?this.con1:this.con2},t.prototype.getLower=function(){return this.mainIsTop?this.con2:this.con1},t.prototype.getLowestMiddle=function(){return this.mainIsTop?this.con2.getLowestMiddleAll()-this.dy2:this.con1.getLowestMiddleAll()-this.dy1},t.prototype.getHighestMiddle=function(){return this.mainIsTop?this.con1.getHighestMiddleAll()-this.dy1:this.con2.getHighestMiddleAll()-this.dy2},t.prototype.paint=function(t,i,e){this.con1.paintAll(t,i+this.dx1,e+this.dy1),this.con2.paintAll(t,i+this.dx2,e+this.dy2)},t.prototype.left=function(t){return t?this.prev:this.con1.last().cursorByLeft(t)},t.prototype.cursorByLeft=function(t){return this},t.prototype.cursorByRight=function(t){return t?this:this.con1.cursorByRight(t)},t.prototype.cursorByLeftFromChild=function(t,i){return this.prev},t.prototype.down=function(t,i){return t?this:this.getLower().last().cursorByLeft(t)},t.prototype.up=function(t,i){return t?this:this.getUpper().last().cursorByLeft(t)},t.prototype.cursorByDown=function(t,i){return this.getUpper().cursorByDown(t,i)},t.prototype.cursorByUp=function(t,i){return this.getLower().cursorByUp(t,i)},t.prototype.cursorByDownFromChild=function(t,i,e){return t.first()==this.getUpper()?i?this:this.getLower().cursorByDown(i,e):null!=this.parent?this.parent.cursorByDownFromChild(this,i,e):null},t.prototype.cursorByUpFromChild=function(t,i,e){return t.first()==this.getLower()?i?this:this.getUpper().cursorByUp(i,e):null!=this.parent?this.parent.cursorByUpFromChild(this,i,e):null},t.prototype.cursorEnterUp=function(){return this.getUpper()},t.prototype.cursorEnterDown=function(){return this.getLower()},t.prototype.fromXY=function(t,i){return t>this.x+this.dim.w&&null!=this.next?this.next.fromXY(t,i):this.d1.isIn(t-this.x-this.dx1,i-this.y-this.dy1)?this.con1.fromXY(t,i):this.d2.isIn(t-this.x-this.dx2,i-this.y-this.dy2)?this.con2.fromXY(t,i):i<this.y+(this.dy1+this.dy2+(this.mainIsTop?this.d1.h2-this.d2.h1:this.d2.h2-this.d1.h1))/2?this.getUpper().fromXY(t,i):this.getLower().fromXY(t,i)},t.prototype.toString=function(t){return"{"+this.con1.toStringAll(t)+"}{"+this.con2.toStringAll(t)+"}"},t}(r.Term);r.DoubleContainerTerm=t}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i,!0)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d1.copy(0,0,0),this.con1.calcDimAll(t,this.d1,i),this.d2.copy(0,0,0),this.con2.calcDimAll(t,this.d2,i);var e=this.fp.getMiddleDelta(t),n=this.fp.getLineThickness(t),s=this.d1.w>this.d2.w?this.d1.w:this.d2.w;this.dx1=2*n+(s-this.d1.w)/2,this.dx2=2*n+(s-this.d2.w)/2,this.dy1=-e-3*n/2-this.d1.h2,this.dy2=3*n-3*n/2-e+this.d2.h1,this.dim.w=s+4*n,this.dim.h1=-this.dy1+this.d1.h1,this.dim.h2=this.dy2+this.d2.h2},t.prototype.paint=function(t,i,e){this.con1.paintAll(t,i+this.dx1,e+this.dy1),this.con2.paintAll(t,i+this.dx2,e+this.dy2)},t.prototype.toString=function(t){return"\\above"+e.prototype.toString.call(this,t)},t.prototype.toMPad=function(){return"{"+this.con1.toMPadAll()+"}\\over{"+this.con2.toMPadAll()+"}"},t}(t.DoubleContainerTerm);t.AboveTerm=i}(fe||(fe={})),function(s){var t=function(n){function t(t,i){var e=n.call(this,t,i)||this;return e.con=new s.EmptyTerm(t,e),e.d=new s.Dim,e}return __extends(t,n),t.prototype.getNCon=function(){return 1},t.prototype.setCon=function(t,i){0==i&&(this.con=t,this.con.setParentAll(this))},t.prototype.getCon=function(t){return 0==t?this.con:null},t.prototype.getLowestMiddle=function(){return this.con.getLowestMiddleAll()-this.dy},t.prototype.getHighestMiddle=function(){return this.con.getHighestMiddleAll()-this.dy},t.prototype.paint=function(t,i,e){this.con.paintAll(t,i+this.dx,e+this.dy)},t.prototype.left=function(t){return t?this.prev:this.con.last().cursorByLeft(t)},t.prototype.cursorByLeft=function(t){return this},t.prototype.cursorByRight=function(t){return t?this:this.con.cursorByRight(t)},t.prototype.cursorByLeftFromChild=function(t,i){return this.prev},t.prototype.cursorByDown=function(t,i){return this.con.cursorByDown(t,i)},t.prototype.cursorByUp=function(t,i){return this.con.cursorByUp(t,i)},t.prototype.cursorByDownFromChild=function(t,i,e){return i?this:null!=this.parent?this.parent.cursorByDownFromChild(this,i,e):null},t.prototype.cursorByUpFromChild=function(t,i,e){return i?this:null!=this.parent?this.parent.cursorByUpFromChild(this,i,e):null},t.prototype.fromXY=function(t,i){return t>this.x+this.dim.w&&null!=this.next?this.next.fromXY(t,i):t>this.x+(this.dx+this.d.w+this.dim.w)/2?this:this.con.fromXY(t,i)},t.prototype.toString=function(t){return"SingleTerm("+this.con.toStringAll(t)+")"},t}(s.Term);s.SingleContainerTerm=t}(fe||(fe={})),function(t){var i=function(s){function r(t,i,e){var n=s.call(this,t,i)||this;return n.centerBr=!1,n.canUseFont=!0,n.type=e,n}return __extends(r,s),r.prototype.calcDim=function(t,i){this.d.copy(0,0,0),this.con.calcDimAll(t,this.d,i);var e=this.fp.getMiddleDelta(t),n=this.d.h1-e>this.d.h2+e?this.d.h1-e:this.d.h2+e,s=this.fp.getLineThickness(t);this.addBorder=r.borderFactor[this.type]*s,this.dx=this.addBorder,this.dy=0,this.dim.w=2*this.addBorder+this.d.w,this.canUseFont=!0,this.centerBr?(this.dim.h1=n+2*s+e,this.dim.h2=n+2*s-e):(this.dim.h1=this.d.h1,this.dim.h2=this.d.h2,this.con.containsBrackets()==this.dim.h1+this.dim.h2&&(this.canUseFont=!1,this.dim.h1=this.d.h1+2*s,this.dim.h2=this.d.h2+2*s))},r.prototype.paint=function(t,i,e){this.con.paintAll(t,i+this.dx,e+this.dy);var n=this.fp.getFontDim(0,this.iFontSize),s=this.fp.getLineThickness(this.iFontSize),r=t.getContext("2d");if(r.save(),0==this.type)if(this.d.h1<=n.h1&&this.d.h2<=n.h2&&this.canUseFont)r.font=this.fp.getFont(0,this.iFontSize),r.fillText("(",i,e-s),r.fillText(")",i+this.addBorder+this.d.w+s+s+s-r.measureText(")").width,e-s);else{var o=s+s,h=(o*o+(d=(this.dim.h1+this.dim.h2)/2)*d)/2/o,u=Math.atan(2*o*d/(d*d-o*o));r.beginPath(),r.arc(i+s/2+h,e-this.dim.h1+d,h,Math.PI-u,Math.PI+u),r.stroke(),r.beginPath(),r.arc(i+this.addBorder+this.d.w+3*s/2-h,e-this.dim.h1+d,h,-u,u),r.stroke(),h=((o=s+s-1)*o+d*d)/2/o,u=Math.atan(2*o*d/(d*d-o*o)),r.beginPath(),r.arc(i+s/2+1+h,e-this.dim.h1+d,h,Math.PI-u,Math.PI+u),r.stroke(),r.beginPath(),r.arc(i+this.addBorder+this.d.w+3*s/2-h-1,e-this.dim.h1+d,h,-u,u),r.stroke()}else if(1==this.type)this.d.h1<=n.h1&&this.d.h2<=n.h2&&this.canUseFont?(r.font=this.fp.getFont(0,this.iFontSize),r.fillText("[",i,e-s),r.fillText("]",i+this.addBorder+this.d.w+s+s+s-r.measureText(")").width,e-s)):(r.fillRect(i+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+2*s,e-this.dim.h1,2*s,s),r.fillRect(i+2*s,e+this.dim.h2-s,2*s,s),r.fillRect(i+this.addBorder+this.d.w-s,e-this.dim.h1,2*s,s),r.fillRect(i+this.addBorder+this.d.w-s,e+this.dim.h2-s,2*s,s));else if(2==this.type)if(this.d.h1<=n.h1&&this.d.h2<=n.h2&&this.canUseFont)r.font=this.fp.getFont(0,this.iFontSize),r.fillText("{",i,e-s),r.fillText("}",i+this.addBorder+this.d.w+s+s+s-r.measureText(")").width,e-s);else{var d=(this.dim.h1+this.dim.h2)/2,l=e-this.dim.h1+d;this.drawRelLine(r,i+s+s,e-this.dim.h1+s,s,-s,s),r.fillRect(i+s+s,e-this.dim.h1+s,s,d-s-s),this.drawRelLine(r,i+s+s,l-s,-s,s,s),this.drawRelLine(r,i+s+s,l+s,-s,-s,s),r.fillRect(i+s+s,l+s,s,d-s-s),this.drawRelLine(r,i+s+s,l+d-s,s,s,s),this.drawRelLine(r,i+this.addBorder+this.d.w,e-this.dim.h1+s,-s,-s,s),r.fillRect(i+this.addBorder+this.d.w,e-this.dim.h1+s,s,d-s-s),this.drawRelLine(r,i+this.addBorder+this.d.w,l-s,s,s,s),this.drawRelLine(r,i+this.addBorder+this.d.w,l+s,s,-s,s),r.fillRect(i+this.addBorder+this.d.w,l+s,s,d-s-s),this.drawRelLine(r,i+this.addBorder+this.d.w,l+d-s,-s,s,s)}else if(3==this.type){var a=e+(this.dim.h2-this.dim.h1)/2;r.beginPath(),r.moveTo(i+s,a),r.lineTo(i+3*s,e-this.dim.h1),r.moveTo(i+s,a),r.lineTo(i+3*s,e+this.dim.h2),r.moveTo(i+this.addBorder+this.d.w+2*s,a),r.lineTo(i+this.addBorder+this.d.w,e-this.dim.h1),r.moveTo(i+this.addBorder+this.d.w+2*s,a),r.lineTo(i+this.addBorder+this.d.w,e+this.dim.h2),r.stroke()}else 4==this.type?(r.fillRect(i+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2)):5==this.type?(r.fillRect(i+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+3*s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+3*s,e-this.dim.h1,s,this.dim.h1+this.dim.h2)):6==this.type?(r.fillRect(i+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+2*s,e+this.dim.h2-s,2*s,s),r.fillRect(i+this.addBorder+this.d.w-s,e+this.dim.h2-s,2*s,s)):7==this.type&&(r.fillRect(i+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+this.addBorder+this.d.w+s,e-this.dim.h1,s,this.dim.h1+this.dim.h2),r.fillRect(i+2*s,e-this.dim.h1,2*s,s),r.fillRect(i+this.addBorder+this.d.w-s,e-this.dim.h1,2*s,s));r.restore()},r.prototype.toString=function(t){return"\\bracket"+this.type+"{"+this.con.toStringAll(t)+"}"},r.prototype.toMPad=function(){return 0==this.type?"("+this.con.toMPadAll()+")":1==this.type?"["+this.con.toMPadAll()+"]":2==this.type?"\\{"+this.con.toMPadAll()+"\\}":"("+this.con.toMPadAll()+")"},r.prototype.containsBrackets=function(){return s.prototype.containsBrackets.call(this,this.dim.h1+this.dim.h2)},r.borderFactor=[3,3,3,3,3,5,3,3],r}(t.SingleContainerTerm);t.BracketTerm=i}(fe||(fe={})),function(t){var i=function(r){function t(t,i){return r.call(this,t,i)||this}return __extends(t,r),t.prototype.paint=function(t,i,e){r.prototype.paint.call(this,t,i,e);var n=this.fp.getMiddleDelta(this.iFontSize),s=this.fp.getLineThickness(this.iFontSize);t.getContext("2d").fillRect(i+s,e-n-s/2,this.dim.w-2*s,s)},t.prototype.toString=function(t){return"\\frac{"+this.con1.toStringAll(t)+"}{"+this.con2.toStringAll(t)+"}"},t.prototype.toMPad=function(){return"{"+this.con1.toMPadAll()+"}/{"+this.con2.toMPadAll()+"}"},t}(t.AboveTerm);t.FracTerm=i}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d.copy(0,0,0),this.con.calcDimAll(t+1,this.d,i);var e=this.prev.getLowestMiddle();this.dx=0,this.dy=this.d.h1-e+1,this.dim.w=this.d.w,this.dim.h1=-this.dy+this.d.h1,this.dim.h2=this.dy+this.d.h2},t.prototype.getCursorDim=function(){var t=this.fp.getFontDim(0,this.iFontSize);return t.w=this.dim.w,t},t.prototype.toString=function(t){return"_{"+this.con.toStringAll(t)+"}"},t.prototype.toMPad=function(){return"_{"+this.con.toMPadAll()+"}"},t}(t.SingleContainerTerm);t.IndexTerm=i}(fe||(fe={})),function(h){var t=function(o){function t(t,i,e,n){var s=o.call(this,t,i)||this;s.nTerm=e,s.mainTermNr=n,s.con=[],s.d=[],s.dx=[],s.dy=[];for(var r=0;r<s.nTerm;r++)s.con[r]=new h.EmptyTerm(t,s),s.d[r]=new h.Dim;return s}return __extends(t,o),t.prototype.getNCon=function(){return this.nTerm},t.prototype.setCon=function(t,i){var e=i;0==i?e=this.mainTermNr:i<=this.mainTermNr&&e--,e<this.nTerm&&(this.con[e]=t,this.con[e].setParentAll(this))},t.prototype.getCon=function(t){var i=t;return 0==t?i=this.mainTermNr:t<=this.mainTermNr&&i--,i<this.nTerm?this.con[t]:null},t.prototype.getBehavior=function(){return h.Term.ENTER_UPDOWN},t.prototype.getLowestMiddle=function(){for(var t=this.con[0].getLowestMiddleAll()-this.dy[0],i=1;i<this.nTerm;i++){var e=this.con[i].getLowestMiddleAll()-this.dy[i];t<e&&(t=e)}return t},t.prototype.getHighestMiddle=function(){for(var t=this.con[0].getHighestMiddleAll()-this.dy[0],i=1;i<this.nTerm;i++){var e=this.con[i].getHighestMiddleAll()-this.dy[i];e<t&&(t=e)}return t},t.prototype.getTermNr=function(t){for(var i=0;i<this.nTerm;i++)if(this.con[i]==t)return i;return-1},t.prototype.paint=function(t,i,e){for(var n=0;n<this.nTerm;n++)this.con[n].paintAll(t,i+this.dx[n],e+this.dy[n])},t.prototype.left=function(t){return t?this.prev:this.con[this.mainTermNr].last().cursorByLeft(t)},t.prototype.cursorByLeft=function(t){return this},t.prototype.cursorByRight=function(t){return t?this:this.con[this.mainTermNr].cursorByRight(t)},t.prototype.cursorByLeftFromChild=function(t,i){return this.prev},t.prototype.down=function(t,i){return t?this:this.con[this.nTerm-1].last().cursorByLeft(t)},t.prototype.up=function(t,i){return t?this:this.con[0].last().cursorByLeft(t)},t.prototype.cursorByDown=function(t,i){return this.con[0].cursorByDown(t,i)},t.prototype.cursorByUp=function(t,i){return this.con[this.nTerm-1].cursorByUp(t,i)},t.prototype.cursorByDownFromChild=function(t,i,e){return t.first()!=this.con[this.nTerm-1]?i?this:this.con[this.getTermNr(t.first())+1].cursorByDown(i,e):null!=this.parent?this.parent.cursorByDownFromChild(this,i,e):null},t.prototype.cursorByUpFromChild=function(t,i,e){return t.first()!=this.con[0]?i?this:this.con[this.getTermNr(t.first())-1].cursorByUp(i,e):null!=this.parent?this.parent.cursorByUpFromChild(this,i,e):null},t.prototype.cursorEnterUp=function(){return this.con[0]},t.prototype.cursorEnterDown=function(){return this.con[this.nTerm-1]},t.prototype.fromXY=function(t,i){if(t>this.x+this.dim.w&&null!=this.next)return this.next.fromXY(t,i);for(var e=0;e<this.nTerm;e++)if(this.d[e].isIn(t-this.x-this.dx[e],i-this.y-this.dy[e]))return this.con[e].fromXY(t,i);return this.con[this.mainTermNr]},t.prototype.toString=function(t){for(var i="",e=0;e<this.nTerm;e++)i+="{"+this.getCon(e).toStringAll(t)+"}";return i},t}(h.Term);h.MultiContainerTerm=t}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i,!1)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d1.copy(0,0,0),this.con1.calcDimAll(t,this.d1,i),this.d2.copy(0,0,0),this.con2.calcDimAll(t+1,this.d2,i);var e=this.fp.getLineThickness(t);this.dim.w=this.d1.w>this.d2.w?this.d1.w:this.d2.w,this.dx1=(this.dim.w-this.d1.w)/2,this.dy1=0,this.dx2=(this.dim.w-this.d2.w)/2,this.dy2=-this.d2.h1-e-this.d1.h2,this.dim.h1=this.d2.h1-this.dy2,this.dim.h2=this.d1.h2},t.prototype.toString=function(t){return"\\over"+e.prototype.toString.call(this,t)},t.prototype.toMPad=function(){return"{"+this.con1.toMPadAll()+"}\\ontop{"+this.con2.toMPadAll()+"}"},t}(t.DoubleContainerTerm);t.OverTerm=i}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i,3,1)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d[0].copy(0,0,0),this.con[0].calcDimAll(t+1,this.d[0],i),this.d[1].copy(0,0,0),this.con[1].calcDimAll(t,this.d[1],i),this.d[2].copy(0,0,0),this.con[2].calcDimAll(t+1,this.d[2],i);var e=this.fp.getLineThickness(t);this.dim.w=this.d[0].w>this.d[1].w?this.d[0].w:this.d[1].w,this.d[2].w>this.dim.w&&(this.dim.w=this.d[2].w),this.dx[1]=(this.dim.w-this.d[1].w)/2,this.dy[1]=0,this.dx[0]=(this.dim.w-this.d[0].w)/2,this.dy[0]=-this.d[1].h1-e-this.d[0].h2,this.dx[2]=(this.dim.w-this.d[2].w)/2,this.dy[2]=this.d[1].h2+e+this.d[2].h1,this.dim.h1=this.d[0].h1-this.dy[0],this.dim.h2=this.d[2].h2+this.dy[2]},t.prototype.toString=function(t){return"\\overunder"+e.prototype.toStringAll.call(this,t)},t.prototype.toMPad=function(){return"{"+this.con[0].toMPadAll()+"}\\ontop{"+this.con[1].toMPadAll()+"}\\below{"+this.con[2].toMPadAll()+"}"},t}(t.MultiContainerTerm);t.OverUnderTerm=i}(fe||(fe={})),function(t){var i=function(s){function t(t,i,e){void 0===e&&(e=!0);var n=s.call(this,t,i,!0)||this;return n._left=!1,n._left=e,n}return __extends(t,s),t.prototype.calcDim=function(t,i){this.d1.copy(0,0,0),this.con1.calcDimAll(t+1,this.d1,i),this.d2.copy(0,0,0),this.con2.calcDimAll(t+1,this.d2,i),this.dim.w=this.d1.w>this.d2.w?this.d1.w:this.d2.w;var e=this.prev.getHighestMiddle();this.dx1=this._left?this.dim.w-this.d1.w:0,this.dy1=-this.d1.h2-e-1,e=this.prev.getLowestMiddle(),this.dx2=this._left?this.dim.w-this.d2.w:0,this.dy2=this.d2.h1-e+1,this.dim.h1=-this.dy1+this.d1.h1,this.dim.h2=this.dy2+this.d2.h2},t.prototype.toString=function(t){return"^{"+this.con1.toStringAll(t)+"}_{"+this.con2.toStringAll(t)+"}"},t.prototype.toMPad=function(){return"^{"+this.con1.toMPadAll()+"}_{"+this.con2.toMPadAll()+"}"},t}(t.DoubleContainerTerm);t.PowIndTerm=i}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d.copy(0,0,0),this.con.calcDimAll(t+1,this.d,i);var e=this.prev.getHighestMiddle();this.dx=0,this.dy=-this.d.h2-e-1,this.dim.w=this.d.w,this.dim.h1=-this.dy+this.d.h1,this.dim.h2=this.dy+this.d.h2},t.prototype.getCursorDim=function(){var t=this.fp.getFontDim(0,this.iFontSize);return t.w=this.dim.w,t},t.prototype.toString=function(t){return"^{"+this.con.toStringAll(t)+"}"},t.prototype.toMPad=function(){return"^{"+this.con.toMPadAll()+"}"},t}(t.SingleContainerTerm);t.PowerTerm=i}(fe||(fe={})),function(t){var i=function(o){function t(t,i){return o.call(this,t,i,!1)||this}return __extends(t,o),t.prototype.calcDim=function(t,i){this.d1.copy(0,0,0),this.con1.calcDimAll(t,this.d1,i),this.d2.copy(0,0,0),this.con2.calcDimAll(t+1,this.d2,i);var e=this.fp.getMiddleDelta(t),n=this.fp.getLineThickness(t);this.dx1=this.d2.w+4*n,this.dy1=0,this.dx2=n,this.dy2=-this.d2.h2-e-n,this.dim.w=this.dx1+this.d1.w+2*n;var s=this.d1.h1+2*n,r=this.d2.h1-this.dy2;this.dim.h1=r<s?s:r,this.dim.h2=this.d1.h2},t.prototype.paint=function(t,i,e){o.prototype.paint.call(this,t,i,e);var n=this.fp.getLineThickness(this.iFontSize),s=this.fp.getMiddleDelta(this.iFontSize)+n/2,r=t.getContext("2d");r.fillRect(i+n,e-s,this.d2.w,n),r.beginPath(),r.moveTo(i+n+this.d2.w,e-s),r.lineTo(i+2*n+this.d2.w,e+this.d1.h2),r.moveTo(i+2*n+this.d2.w,e+this.d1.h2),r.lineTo(i+this.dx1,e-this.d1.h1-n),r.stroke(),r.fillRect(i+this.dx1,e-this.d1.h1-2*n,2*n+this.d1.w-1,n)},t.prototype.fromXY=function(t,i){return t>this.x+this.dim.w&&null!=this.next?this.next.fromXY(t,i):t<=this.x+this.d2.w?this.con2.fromXY(t,i):this.con1.fromXY(t,i)},t.prototype.toString=function(t){return"\rootn"+o.prototype.toString.call(this,t)},t.prototype.toMPad=function(){return"{"+this.con2.toMPadAll()+"}\\nroot{"+this.con1.toMPadAll()+"}"},t}(t.DoubleContainerTerm);t.RootNTerm=i}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d.copy(0,0,0),this.con.calcDimAll(t,this.d,i);var e=this.fp.getLineThickness(t);this.dx=5*e,this.dy=0,this.dim.w=6*e+this.d.w,this.dim.h1=this.d.h1+2*e,this.dim.h2=this.d.h2},t.prototype.paint=function(t,i,e){this.con.paintAll(t,i+this.dx,e+this.dy);var n=this.fp.getLineThickness(this.iFontSize),s=this.fp.getMiddleDelta(this.iFontSize)+n/2,r=t.getContext("2d");r.fillRect(i+n,e-s,n,n),r.beginPath(),r.moveTo(i+2*n,e-s),r.lineTo(i+3*n,e+this.d.h2),r.moveTo(i+3*n,e+this.d.h2),r.lineTo(i+4*n,e-this.d.h1-n),r.stroke(),r.fillRect(i+4*n,e-this.d.h1-2*n,2*n+this.d.w-1,n)},t.prototype.toString=function(t){return"\root2{"+this.con.toStringAll(t)+"}"},t.prototype.toMPad=function(){return"\\root{"+this.con.toMPadAll()+"}"},t}(t.SingleContainerTerm);t.RootTerm=i}(fe||(fe={})),function(o){var t=function(r){function t(t,i,e,n){var s=r.call(this,t,i)||this;return s.s=e,s.iFontIndex=n,s}return __extends(t,r),t.prototype.calcDim=function(t,i){var e=i.getContext("2d");e.font=this.fp.getFont(this.iFontIndex,this.iFontSize);var n=e.measureText(this.s),s=this.fp.getFontMetrics(this.iFontIndex,this.iFontSize);this.dim.h1=o.Term.correctAscent(s.getAscent()),this.dim.h2=s.getDescent(),this.dim.w=n.width},t.prototype.paint=function(t,i,e){var n=t.getContext("2d");n.save(),n.font=this.fp.getFont(this.iFontIndex,this.iFontSize),n.fillText(this.s,i,e),n.restore()},t.prototype.toString=function(){return this.s},t.prototype.toMPad=function(){return this.s},t}(o.Term);o.SimpleTerm=t}(fe||(fe={})),function(t){var i=function(){function e(t,i){this.next=i,(this.prev=null)!=i&&(i.prev=this),this.term=t}return e.MakeTermChainer=function(t){for(var i=new e(t,null);null!=i.term.parent;)i=new e(i.term.parent,i);return i},e}();t.TermChainer=i}(fe||(fe={})),function(t){var i=function(){function t(t){this.s=t,this.i=0}return t.prototype.back=function(){0<this.i&&this.i--},t.prototype.eof=function(){return this.i>=this.s.length},t.prototype.nextChar=function(){return this.eof()?null:this.s.charAt(this.i++)},t.prototype.nextCharCode=function(){return this.eof()?null:this.s.charCodeAt(this.i++)},t.prototype.checkNextChar=function(){return this.eof()?null:this.s.charAt(this.i)},t.prototype.check=function(t){return this.s.indexOf(t,this.i)==this.i},t.prototype.skip=function(t){this.i+=t,this.i>this.s.length&&(this.i=this.s.length)},t}();t.StrPtr=i}(fe||(fe={})),function(g){var t=function(){function y(){}return y.createTerm=function(t,i,e){return"frac"==t?new g.FracTerm(i,e):"above"==t?new g.AboveTerm(i,e):"root"==t?new g.RootTerm(i,e):"rootn"==t?new g.RootNTerm(i,e):"bracket"==t.substr(0,7)?new g.BracketTerm(i,e,parseInt(t.substr(7))):"index"==t?new g.IndexTerm(i,e):"power"==t?new g.PowerTerm(i,e):"powind"==t?new g.PowIndTerm(i,e,!1):"lindex"==t?new g.IndexTerm(i,e):"lpower"==t?new g.PowerTerm(i,e):"lpowind"==t?new g.PowIndTerm(i,e,!0):"under"==t?new g.UnderTerm(i,e):"over"==t?new g.OverTerm(i,e):"overunder"==t?new g.OverUnderTerm(i,e):null},y.readStringS1=function(t,i,e){return y.readString(new g.StrPtr(t),i,null,!0,e)},y.readStringS2=function(t,i,e,n){return y.readString(new g.StrPtr(t),i,e,!0,n)},y.readString=function(t,i,e,n,s){for(var r,o,h=new g.EmptyTerm(i,e),u=h,d=0,l=!1;!t.eof();)if(t.check("FONT"))t.skip(4),d=t.nextCharCode()-"0".charCodeAt(0);else if(t.check("\\CURSOR"))t.skip(7),l=!0;else{var a=t.nextChar();if("}"==a)return h;if("#"==a)null!=s&&(s.setParentAll(e),u.insertChainAsNext(s),u=u.next);else if("_"==a){var c=y.readStringPara(t,i,null,s);"^"==t.checkNextChar()?(u.insertAsNext(o=new g.PowIndTerm(i,e)),u=u.next,c.setParentAll(u),o.con2=c,t.nextChar(),o.con1=y.readStringPara(t,i,o,s)):(u.insertAsNext(r=new g.IndexTerm(i,e)),u=u.next,c.setParentAll(u),r.con=c)}else if("^"==a){c=y.readStringPara(t,i,null,s);"_"==t.checkNextChar()?(u.insertAsNext(o=new g.PowIndTerm(i,e)),u=u.next,c.setParentAll(u),o.con1=c,t.nextChar(),o.con2=y.readStringPara(t,i,o,s)):(u.insertAsNext(r=new g.PowerTerm(i,e)),u=u.next,c.setParentAll(u),r.con=c)}else if("\\"!=a)u.insertAsNext(new g.SimpleTerm(i,e,""+a,d)),u=u.next;else if("\\"==t.checkNextChar())u.insertAsNext(new g.SimpleTerm(i,e,"\\",d)),u=u.next,t.nextChar();else{for(var p="";!t.eof()&&";"!=(a=t.nextChar());){if("{"==a||"\\"==a||"#"==a){t.back();break}p+=a}var f=y.createTerm(p,i,e);if(null!=f){u.insertAsNext(f),u=u.next;for(var m=0;m<u.getNCon();m++)u.setCon(y.readStringPara(t,i,u,s),m)}}if(d=0,l&&(l=!1,i.setCursor(u)),!n)break}return h},y.readStringPara=function(t,i,e,n){return t.eof()?new g.EmptyTerm(i,e):"{"==t.nextChar()?y.readString(t,i,e,!0,n):(t.back(),y.readString(t,i,e,!1,n))},y}();g.TermFactory=t}(fe||(fe={})),function(t){var i=function(e){function t(t,i){return e.call(this,t,i,!0)||this}return __extends(t,e),t.prototype.calcDim=function(t,i){this.d1.copy(0,0,0),this.con1.calcDimAll(t,this.d1,i),this.d2.copy(0,0,0),this.con2.calcDimAll(t+1,this.d2,i);var e=this.fp.getLineThickness(t);this.dim.w=this.d1.w>this.d2.w?this.d1.w:this.d2.w,this.dx1=(this.dim.w-this.d1.w)/2,this.dy1=0,this.dx2=(this.dim.w-this.d2.w)/2,this.dy2=this.d1.h2+e+this.d2.h1,this.dim.h1=this.d1.h1,this.dim.h2=this.d2.h2+this.dy2},t.prototype.toString=function(t){return"\\under"+e.prototype.toString.call(this,t)},t.prototype.toMPad=function(){return"{"+this.con1.toMPadAll()+"}\\below{"+this.con2.toMPadAll()+"}"},t}(t.DoubleContainerTerm);t.UnderTerm=i}(fe||(fe={})),function(t){var i=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];this.x1=-1,this.y1=-1,this.x2=-1,this.y2=-1,this.c=t[0],this.x1=t[1],this.y1=t[2],this.x2=t[3],this.y2=t[4]};(fe||(fe={})).ColorArea=i}(),function(t){var i=function(){function t(){}return t.getAbsDim=function(t){for(var i=0,e=0,n=t.clientWidth,s=t.clientHeight;t;)"BODY"==t.tagName?(i+=t.offsetLeft+t.clientLeft,e+=t.offsetTop+t.clientTop):(i+=t.offsetLeft+t.scrollLeft+t.clientLeft,e+=t.offsetTop+t.scrollTop+t.clientTop),t=t.offsetParent;return{x:i,y:e,w:n,h:s}},t}();t.ElementUtils=i}(fe||(fe={}));